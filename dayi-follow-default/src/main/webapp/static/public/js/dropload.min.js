(function(o){"use strict";var t=window;var e=document;var s=o(t);var n=o(e);o.fn.dropload=function(o){return new i(this,o)};var i=function(o,t){var e=this;e.$element=o;e.upInsertDOM=false;e.loading=false;e.isLockUp=false;e.isLockDown=false;e.isData=true;e._scrollTop=0;e._threshold=0;e.init(t)};i.prototype.init=function(i){var p=this;p.opts=o.extend(true,{},{scrollArea:p.$element,domUp:{domClass:"dropload-up",domRefresh:'<div class="dropload-refresh">↓下拉刷新</div>',domUpdate:'<div class="dropload-update">↑释放更新</div>',domLoad:'<div class="dropload-load"><span class="d-loading"></span>加载中...</div>'},domDown:{domClass:"dropload-down",domRefresh:"",domLoad:'<div class="dropload-load"><span class="d-loading"></span>加载中...</div>',domNoData:""},autoLoad:true,distance:50,threshold:"",loadUpFn:"",loadDownFn:""},i);if(p.opts.loadDownFn!=""){p.$element.append('<div class="'+p.opts.domDown.domClass+'">'+p.opts.domDown.domRefresh+"</div>");p.$domDown=o("."+p.opts.domDown.domClass)}if(!!p.$domDown&&p.opts.threshold===""){p._threshold=Math.floor(p.$domDown.height()*1/3)}else{p._threshold=p.opts.threshold}if(p.opts.scrollArea==t){p.$scrollArea=s;p._scrollContentHeight=n.height();p._scrollWindowHeight=e.documentElement.clientHeight}else{p.$scrollArea=p.opts.scrollArea;p._scrollContentHeight=p.$element[0].scrollHeight;p._scrollWindowHeight=p.$element.height()}c(p);s.on("resize",function(){if(p.opts.scrollArea==t){p._scrollWindowHeight=t.innerHeight}else{p._scrollWindowHeight=p.$element.height()}});p.$element.on("touchstart",function(o){if(!p.loading){l(o);d(o,p)}});p.$element.on("touchmove",function(o){if(!p.loading){l(o,p);r(o,p)}});p.$element.on("touchend",function(){if(!p.loading){a(p)}});p.$scrollArea.on("scroll",function(){p._scrollTop=p.$scrollArea.scrollTop();if(p.opts.loadDownFn!=""&&!p.loading&&!p.isLockDown&&p._scrollContentHeight-p._threshold<=p._scrollWindowHeight+p._scrollTop){h(p)}})};function l(o){if(!o.touches){o.touches=o.originalEvent.touches}}function d(o,t){t._startY=o.touches[0].pageY;t.touchScrollTop=t.$scrollArea.scrollTop()}function r(t,e){e._curY=t.touches[0].pageY;e._moveY=e._curY-e._startY;if(e._moveY>0){e.direction="down"}else if(e._moveY<0){e.direction="up"}var s=Math.abs(e._moveY);if(e.opts.loadUpFn!=""&&e.touchScrollTop<=0&&e.direction=="down"&&!e.isLockUp){t.preventDefault();e.$domUp=o("."+e.opts.domUp.domClass);if(!e.upInsertDOM){e.$element.prepend('<div class="'+e.opts.domUp.domClass+'"></div>');e.upInsertDOM=true}f(e.$domUp,0);if(s<=e.opts.distance){e._offsetY=s;e.$domUp.html(e.opts.domUp.domRefresh)}else if(s>e.opts.distance&&s<=e.opts.distance*2){e._offsetY=e.opts.distance+(s-e.opts.distance)*.5;e.$domUp.html(e.opts.domUp.domUpdate)}else{e._offsetY=e.opts.distance+e.opts.distance*.5+(s-e.opts.distance*2)*.2}e.$domUp.css({height:e._offsetY})}}function a(t){var e=Math.abs(t._moveY);if(t.opts.loadUpFn!=""&&t.touchScrollTop<=0&&t.direction=="down"&&!t.isLockUp){f(t.$domUp,300);if(e>t.opts.distance){t.$domUp.css({height:t.$domUp.children().height()});t.$domUp.html(t.opts.domUp.domLoad);t.loading=true;t.opts.loadUpFn(t)}else{t.$domUp.css({height:"0"}).on("webkitTransitionEnd mozTransitionEnd transitionend",function(){t.upInsertDOM=false;o(this).remove()})}t._moveY=0}}function c(o){if(o.opts.autoLoad){if(o._scrollContentHeight-o._threshold<=o._scrollWindowHeight){h(o)}}}function p(o){if(o.opts.scrollArea==t){o._scrollContentHeight=n.height()}else{o._scrollContentHeight=o.$element[0].scrollHeight}}function h(o){o.direction="up";o.$domDown.html(o.opts.domDown.domLoad);o.loading=true;o.opts.loadDownFn(o)}i.prototype.lock=function(o){var t=this;if(o===undefined){if(t.direction=="up"){t.isLockDown=true}else if(t.direction=="down"){t.isLockUp=true}else{t.isLockUp=true;t.isLockDown=true}}else if(o=="up"){t.isLockUp=true}else if(o=="down"){t.isLockDown=true;t.direction="up"}};i.prototype.unlock=function(){var o=this;o.isLockUp=false;o.isLockDown=false;o.direction="up"};i.prototype.noData=function(o){var t=this;if(o===undefined||o==true){t.isData=false}else if(o==false){t.isData=true}};i.prototype.resetload=function(){var t=this;if(t.direction=="down"&&t.upInsertDOM){t.$domUp.css({height:"0"}).on("webkitTransitionEnd mozTransitionEnd transitionend",function(){t.loading=false;t.upInsertDOM=false;o(this).remove();p(t)})}else if(t.direction=="up"){t.loading=false;if(t.isData){t.$domDown.html(t.opts.domDown.domRefresh);p(t);c(t)}else{t.$domDown.html(t.opts.domDown.domNoData)}}};i.prototype.unbind=function(){var o=this;o.$element.off("touchstart touchmove touchend");o.opts.scrollArea.off("scroll");o.opts.loadDownFn="";o.$domDown.remove()};function f(o,t){o.css({"-webkit-transition":"all "+t+"ms",transition:"all "+t+"ms"})}})(window.Zepto||window.jQuery);