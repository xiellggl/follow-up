<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dayi.follow.dao.dayi.AgentMapper">


    <!--查找代理商最后登录时间-->
    <select id="findLastLoginTime" resultType="java.util.Date" parameterType="java.lang.Integer">
         SELECT create_date FROM `finance_login_log` WHERE login_id = #{agentId} ORDER BY create_date DESC LIMIT 1
    </select>
    <!--查找代理商最近代理数据-->
    <select id="countRecentAgent" resultType="com.dayi.follow.vo.AgentListVo" parameterType="java.lang.Integer">
            SELECT DATE_FORMAT(create_date, '%Y-%m-%d') recentAgentDate, IFNULL(SUM(amount), 0) recentAgentFund
             FROM protocol WHERE (STATUS = 1 OR STATUS = 2) AND agent = #{agentId}
             GROUP BY recentAgentDate
             ORDER BY recentAgentDate DESC
            LIMIT 0, 1
    </select>

    <!--统计首页的客户状态-->
    <select id="countCusStatus" resultType="com.dayi.follow.vo.IndexVo" parameterType="java.lang.String">

       SELECT SUM(t.agentCount) agentCount, SUM(t.linkTotal) linkTotal, SUM(t.signTotal) signTotal, SUM(t.inCashTotal) inCashTotal, ")
             SUM(t.idCardToal) idCardTotal, SUM(t.agentTotal) agentTotal, SUM(t.noFundTotal) noFundTotal,sum(t.lostTotal) lostTotal ")
         FROM (
        // 跟进用户总数
         SELECT count(0) agentCount, 0 linkTotal, 0 signTotal, 0 inCashTotal, 0 idCardToal, 0 agentTotal, 0 noFundTotal,0 lostTotal  ")
           FROM agent a WHERE 1 = 1 and a.del_status != -1").append(str)
        // 已联系--用户人数
        UNION
        SELECT 0, count(0) b, 0, 0, 0, 0, 0,0 FROM agent a WHERE customer_type != 1 and a.del_status != -1").append(str)
        // 已实名认证--用户人数
         UNION
         SELECT 0, 0, 0, 0, count(0) e, 0, 0,0 FROM agent a WHERE (audit_status IN (1 ,- 3) OR cancel_status = 3) and a.del_status != -1").append(str)
        // 已绑卡--用户人数
         UNION
         SELECT 0, 0, count(0) c, 0, 0, 0, 0,0 FROM agent a WHERE bank_account is not null and a.del_status != -1").append(str)
        // 已入金--用户人数
         UNION
         SELECT 0, 0, 0, count(0) d, 0, 0, 0,0 FROM agent a LEFT JOIN finance_account b ON a.account_id = b.id WHERE b.total_in_cash > 0  and a.del_status != -1").append(str)
        // 已代理--用户人数
         UNION
         SELECT 0, 0, 0, 0, 0, count(0) f, 0,0 FROM agent a, (SELECT DISTINCT agent FROM protocol ) c WHERE a.id = c.agent and a.del_status != -1").append(str)
        // 总资产为零--用户人数
         UNION
         SELECT 0, 0, 0, 0, 0, 0, count(0) g,0 FROM agent a LEFT JOIN finance_account b ON a.account_id = b.id ")
          LEFT JOIN (SELECT agent, IFNULL(SUM(amount), 0) amount from protocol WHERE (status = 1 OR status = 2) GROUP BY agent) c ON a.id = c.agent ")
         WHERE a.del_status != -1 and IFNULL(b.useable + b.frozen + b.out_frozen + IFNULL(c.amount, 0), 0) = 0 ").append(str)
        //流失客户
         UNION
         select 0, 0, 0, 0, 0, 0, 0,count(0) from agent a WHERE customer_type =5 and del_status != -1").append(str)
         ) t
    </select>

</mapper>