<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dayi.follow.dao.dayi.AgentMapper">
    <resultMap id="BaseResultMap" type="com.dayi.follow.vo.AgentListVo">
        <id property="id" column="id" />
        <!--&lt;!&ndash;follow_up&ndash;&gt;-->
        <!--<result property="flowUpInviteCode" column="flowUpInviteCode" />-->

        <!--&lt;!&ndash;follow_agent&ndash;&gt;-->
        <!--<result property="customerType" column="customer_type" />-->
        <!--<result property="cusIntentionType" column="cus_intention_type" />-->
        <!--<result property="flowId" column="flow_id" />-->
        <!--<result property="flowDate" column="flow_date" />-->
        <!--<result property="followUp" column="follow_up" />-->

        <!--agent-->
        <result property="linkPerson" column="link_person" />
        <result property="bankName" column="bank_name" />
        <result property="cardValidDate" column="card_valid_date" />
        <result property="bankSignDate" column="bank_sign_date" />
        <result property="mobile" column="mobile" />
        <result property="idCardValidate" column="id_card_validate" />
        <result property="cancelStatus" column="cancel_status" />
        <result property="auditStatus" column="audit_status" />
        <result property="bankSign" column="bank_sign" />
        <result property="recordInviteCode" column="record_invite_code" />
        <result property="idCard" column="id_card" />


        <!--finance_account-->
        <result property="inCash" column="inCash" />
        <result property="fristInCashDate" column="frist_in_cash_date" />

        <!--finance_account\protocol-->
        <result property="totalFund" column="totalFund" />

        <!--finance_account_log-->
        <result property="dayInCash" column="dayInCash" />
        <result property="dayOutCash" column="dayOutCash" />
        <result property="dayLastInCashTime" column="dayLastInCashTime" />
        <result property="dayLastOutCashTime" column="dayLastOutCashTime" />

        <result property="createDate" column="create_date" />
    </resultMap>


    <sql id="findAgentsSelect">
         SELECT 
                a.id, a.link_person , a.bank_name , a.create_date ,
                a.card_valid_date ,a.bank_sign_date , a.mobile,
                a.bank_sign , a.record_invite_code ,
                a.id_card ,
                
                IFNULL(d.total_in_cash, 0) inCash,
                d.frist_in_cash_date ,
                IFNULL(d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0) totalFund,
                
                IFNULL(f.outCash, 0) dayOutCash,
                IFNULL(f.inCash, 0) dayInCash,
                f.dayLastInCashTime,
                f.dayLastOutCashTime

    </sql>

    <sql id="countNum">
        SELECT count(0)
    </sql>

    <sql id="findAgentsSql">
            from agent a

            left join finance_account d on d.id = a.account_id

            left join (
              SELECT agent, IFNULL(SUM(amount), 0) amount from protocol WHERE (status = 1 OR status = 2) GROUP BY agent
            )e on e.agent=a.id

            left join (
                SELECT pay_uc_id, MAX( CASE WHEN pay_type = '1' THEN accrual END ) AS inCash,
                     MAX(CASE WHEN pay_type = '-114' THEN accrual END ) AS outCash,
                     MAX(CASE WHEN pay_type = '1' THEN createDate END ) AS dayLastInCashTime,
                     MAX(CASE WHEN pay_type = '-114' THEN createDate END ) AS dayLastOutCashTime
                     FROM (
                        SELECT pay_uc_id,`pay_type`,SUM(accrual) accrual,MAX(`create_date`)createDate
                        FROM finance_account_log
                        WHERE create_date BETWEEN #{startStr} and #{endStr}
                        AND pay_type  IN (1,-114) and account_type = 0
                        GROUP BY pay_uc_id,`pay_type`
                          )f1
                     GROUP BY `pay_uc_id`
            )f ON a.uc_id = f.pay_uc_id

            left join (
                  SELECT agent_id,GROUP_CONCAT( bank_id ORDER BY bank_id ) bank_ids
                  FROM finance_vitrual_account
                  GROUP BY agent_id
              )g ON a.id = g.agent_id

           WHERE 1 = 1 and a.del_status != -1




    </sql>

    <sql id="ConditionQuery">
        -- 跟进人对应的代理商id集合
        <if test="null!=agentIdList and 0!=agentIdList.size()">
            and a.id in
            <foreach item="item" index="index" collection="agentIdList"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        -- 今日待联系代理商的ID集合
        <if test="null!=ids and 0!=ids.size()">
            and a.id in
            <foreach item="item" index="index" collection="ids"
                     open="(" separator="," close=")">
                #{item}
        </foreach>
        </if>
        <if test="null!=ids and 0==ids.size()">
            and 0 = 1
        </if>
        -- 下面是页面查询条件
        -- 是否实名认证
        <if test="null!=searchVo.idCardValidate and -1!=searchVo.idCardValidate">
            <choose>
                <when test="1==searchVo.idCardValidate">
                    AND (a.audit_status IN (1 ,- 3) OR a.cancel_status = 3)
                </when>
                <otherwise>
                    AND (a.audit_status NOT IN (1 ,- 3) AND a.cancel_status != 3)
                </otherwise>
            </choose>
        </if>
        -- 是否绑卡
        <if test="null!=searchVo.bankSign and -1!=searchVo.bankSign">
            <if test="0==searchVo.bankSign">
                AND a.bank_account is null
            </if>
            <if test="1==searchVo.bankSign">
                AND a.bank_account is not null
            </if>
        </if>
        -- 已开通结算银行
        <if test="null!=searchVo.bankType and ''!=searchVo.bankType">
            and g.bank_ids like '%#{bankType}%'
        </if>

        -- 客户总资产
        <if test="null!=searchVo.totalFound and -1!=searchVo.totalFound">
            -- 总资产为0
            <if test="1==searchVo.totalFound">
                AND IFNULL(d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0) = 0
            </if>
            -- 2W及2W以下(不包括0)不包括0
            <if test="2==searchVo.totalFound">
                AND 0 &lt; IFNULL (d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0)
                AND IFNULL(d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0) &lt;= 20000
            </if>
            -- 2W~10W
            <if test="3==searchVo.totalFound">
                AND 20000 &lt; IFNULL(d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0)
                AND IFNULL(d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0) &lt;= 100000
            </if>
            -- 10W~50W
            <if test="4==searchVo.totalFound">
                AND 100000 &lt; IFNULL(d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0)
                AND IFNULL(d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0) &lt;= 500000
            </if>
            -- 50W~100W
            <if test="5==searchVo.totalFound">
                AND 500000 &lt; IFNULL(d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0)
                AND IFNULL(d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0) &lt;= 1000000
            </if>
            -- 100W~300W
            <if test="6==searchVo.totalFound">
                AND 1000000 &lt; IFNULL(d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0)
                AND IFNULL(d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0) &lt;= 3000000
            </if>
            -- 300W以上
            <if test="7==searchVo.totalFound">
                AND IFNULL(d.useable + d.frozen + d.out_frozen + IFNULL(e.amount, 0), 0) > 3000000
            </if>
        </if>

        -- 是否入金
        <if test="-1!=searchVo.inCash">
            <choose>
                <when test="1==searchVo.inCash">
                    AND ifnull(d.total_in_cash,0) > 0
                </when>
                <otherwise>
                    AND ifnull(d.total_in_cash,0) &lt;= 0
                </otherwise>
            </choose>
        </if>

        -- 今日是否入金
        <if test=" null!=searchVo.todayInCash and -1!=searchVo.todayInCash">
            <choose>
                <when test="1==searchVo.todayInCash">
                    AND ifnull(f.inCash,0) > 0
                </when>
                <otherwise>
                    AND (ifnull(f.inCash,0) &lt;= 0 or f.inCash is null)
                </otherwise>
            </choose>
        </if>

        -- 今日是否出金
        <if test=" null!=searchVo.todayOutCash and -1!=searchVo.todayOutCash">
            <choose>
                <when test="1==searchVo.todayOutCash">
                    AND ifnull(f.outCash,0) > 0
                </when>
                <otherwise>
                    AND (ifnull(f.outCash,0) &lt;= 0 or f.outCash is null)
                </otherwise>
            </choose>
        </if>


        <if test=" ''!=searchVo.mobile and null!=searchVo.mobile">
            AND a.mobile like '%#{searchVo.mobile}%'
        </if>
        -- 页面查询条件：邀请码
        <if test=" ''!=searchVo.inviteCode and null!=searchVo.inviteCode">
            AND a.record_invite_code like like '%#{searchVo.inviteCode}%'
        </if>
    </sql>
    <!--分页-->
    <sql id="pageSql">
        <if test="null!=limitStart and null!=limitEnd">
            LIMIT #{limitStart},#{limitEnd}
        </if>
    </sql>

    <!--分页查找代理商列表-->
    <select id="findAgents" resultMap="BaseResultMap" parameterType="map">
        <include refid="findAgentsSelect"/>
        <include refid="findAgentsSql"/>
        <include refid="ConditionQuery"/>
        <include refid="pageSql"/>
    </select>

    <!--统计分页代理商列表总数-->
    <select id="findAgentsCount" resultType="java.lang.Integer" parameterType="map">
        <include refid="countNum"/>
        <include refid="findAgentsSql"/>
        <include refid="ConditionQuery"/>
    </select>

    <!--查找代理商最后登录时间-->
    <select id="findLastLoginTime" resultType="java.util.Date" parameterType="java.lang.Integer">
         SELECT create_date FROM `finance_login_log` WHERE login_id = #{agentId} ORDER BY create_date DESC LIMIT 1
    </select>
    <!--查找代理商最近代理数据-->
    <select id="countRecentAgent" resultType="com.dayi.follow.vo.AgentListVo" parameterType="java.lang.Integer">
            SELECT DATE_FORMAT(create_date, '%Y-%m-%d') recentAgentDate, IFNULL(SUM(amount), 0) recentAgentFund
             FROM protocol WHERE (STATUS = 1 OR STATUS = 2) AND agent = #{agentId}
             GROUP BY recentAgentDate
             ORDER BY recentAgentDate DESC
            LIMIT 0, 1
    </select>


    
</mapper>